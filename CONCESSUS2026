<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PCR-EPR Member Management</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:"Times New Roman",sans-serif; background:#b0cdea; text-align:center; margin:20px;}
h1,h2 { color:#12984c; }
select,input {padding:8px; margin:5px 0; width:60%; border:1px solid #ccc; border-radius:5px;}
button {padding:6px 12px; margin:4px; border:none; border-radius:5px; cursor:pointer;}
button:hover {background:#14ac56;color:#fff;}
.hidden {display:none;}
.form-container {background:#f4f6f8; padding:20px; border-radius:8px; margin-top:20px; display:inline-block; text-align:left;}
table {margin:auto; background:#fff; border-collapse: collapse; width:100%; display:block; overflow-x:auto;}
table, th, td {border:1px solid #999;}
th, td {padding:5px; text-align:center; white-space:nowrap;}
#memberListContainer, #archivePage, #transferModal, #chartContainer, #dataPage, #familyInfoPage {margin-top:20px;}
label.filter-label {margin-left:5px;}
.action-btn {margin:0 2px;}
#transferModal {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#f4f6f8; padding:20px; border-radius:8px; z-index:1000; min-width:300px;}
#overlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(242, 199, 199, 0.4); z-index:900;}
.close-btn {float:right; cursor:pointer; font-weight:bold; color:#f00;}
#chartContainer {width:80%; margin:auto;}
canvas {max-width:100%;}
.error {border-color: red;}
.error-message {color: red; font-size: 12px; margin-top: 2px;}
</style>
</head>
<body>

<h1>PCR-EPR Member Management</h1>
<p>Presbyterian Church of Rwanda-EPR has 7 presbyteries.</p>
<button id="startBtn" aria-label="Tangiza gukurikirana abakristo">Kanda Hano!</button>
<button id="viewDataBtn" aria-label="Reba Abakristo Data">Reba Abakristo Data</button>

<!-- Presbyteries selection -->
<div id="presbyteriesPage" class="hidden">
<h2>Hitamo Presbyteries & Paruwasi</h2>
<div id="presbyList"></div>
<button id="backToMain" aria-label="Subira ku rubuga rw'ibanze">Subira Inyuma</button>
</div>

<!-- Member Form -->
<div id="memberFormPage" class="hidden">
<h2>Amakuru y'abakristo</h2>
<div class="form-container">
<form id="memberForm">
<label>No:</label>
<input type="text" id="autoNo" readonly><br>
<label>Ishuri:</label>
<select id="schoolSelect" aria-label="Hitamo Ishuri"></select><br>
<div id="schoolSelectError" class="error-message hidden"></div>
<label>Itorero ry'ibanze:</label>
<select id="schoolSelect2" required aria-label="Hitamo Itorero ry'ibanze"><option value="">--Hitamo Itorero--</option></select><br>
<div id="schoolSelect2Error" class="error-message hidden"></div>
<label>Irangamuntu:</label>
<input type="text" placeholder="Shyiramo numero y'irangamuntu" id="idInput" pattern="[1-9][0-9]{15}" title="Irangamuntu igizwe n’imibare 16 itangira n’umubare utari 0" required><br>
<div id="idInputError" class="error-message hidden"></div>
<label>Amazina yombi:</label>
<input type="text" placeholder="Shyiramo amazina" id="nameInput" required><br>
<div id="nameInputError" class="error-message hidden"></div>
<label>Igitsina:</label>
<select id="genderSelect" required aria-label="Hitamo Igitsina"><option value="">--Hitamo--</option><option>Gabo</option><option>Gore</option></select><br>
<div id="genderSelectError" class="error-message hidden"></div>
<label>Irangamimerere:</label>
<select id="MartalstatusSelect" required aria-label="Hitamo Irangamimerere">
  <option value="">---Hitamo---</option>
  <option value="ingaragu">Ingaragu</option>
  <option value="arubatse">Arubatse</option>
  <option value="umupfakazi">Umupfakazi</option>
  <option value="divorce">Divorce</option>
</select><br>
<label>Ububatizo:</label>
<select id="baptismSelect" required aria-label="Hitamo Ububatizo">
  <option value="">--Hitamo--</option>
  <option value="yego">Yarabatijwe</option>
  <option value="oya">Ntiyabatijwe</option>
</select><br>
<label>Itariki y'amavuko:</label>
<select id="yearSelect" required aria-label="Hitamo Umwaka"><option value="">--Hitamo Umwaka--</option></select><br>
<label>Telephone:</label>
<input type="tel" placeholder="Shyiramo nimero ya telephone" id="phoneInput" pattern="07[0-9]{8}" title="Injiza nimero ya telefone itangira na 07 ifite imibare 10" required><br>
<div id="phoneInputError" class="error-message hidden"></div>
<label>Urwego rw'amashuri yize:</label>
<select id="educationSelect" required aria-label="Hitamo urwego rw'amashuri yize">
  <option value="">---Hitamo---</option>
  <option value="Ntazi gusoma">Ntazi gusoma</option>
  <option value="Isomero">Isomero</option>
  <option value="Abanza">Abanza</option>
  <option value="Ayisumbuye">Ayisumbuye</option>
  <option value="Kaminuza">Kaminuza</option>
  <option value="Masters">Masters</option>
  <option value="PHD">PHD</option>
  <option value="Professor">Professor</option>
</select><br>
<div id="educationSelectError" class="error-message hidden"></div>
<label>Icyo akora:</label>
<select id="jobStatusSelect" required aria-label="Hitamo icyo akora">
  <option value="">---Hitamo---</option>
  <option value="Ntakazi agira">Ntakazi agira</option>
  <option value="Arikorera">Arikorera</option>
  <option value="Akorera abandi">Akorera abandi</option>
  <option value="Akorera leta">Akorera leta</option>
  <option value="Akorera NGOs">Akorera NGOs</option>
</select><br>
<div id="jobStatusSelectError" class="error-message hidden"></div>
<button type="button" id="backToPresby" aria-label="Subira ku hitamo presbytery">Subira Inyuma</button>
<button type="submit" aria-label="Ohereza amakuru">Ohereza</button>
</form>
</div>
</div>

<!-- Family Information Page -->
<div id="familyInfoPage" class="hidden">
<h2>Amakuru y'Umuryango</h2>
<div class="form-container">
<form id="familyForm">
<label>Izina ry'umukristo:</label>
<input type="text" id="familyName" readonly><br>
<label>Irangamimerere:</label>
<input type="text" id="familyMaritalStatus" readonly><br>
<label>Uwo bashyingiranwe:</label>
<input type="text" placeholder="Shyiramo izina ry'uwo bashyingiranwe" id="spouseInput" aria-label="Izina ry'uwo bashyingiranwe"><br>
<label>Umwaka bashyingiranwe:</label>
<select id="marriageYearSelect" aria-label="Hitamo umwaka bashyingiranwe"><option value="">--Hitamo Umwaka--</option></select><br>
<div id="marriageYearSelectError" class="error-message hidden"></div>
<label>Umubare w'abana:</label>
<input type="number" placeholder="Shyiramo umubare w'abana" id="childrenInput" min="0" aria-label="Umubare w'abana"><br>
<div id="childrenInputError" class="error-message hidden"></div>
<div id="childrenNamesContainer">
  <label>Amazina y'Abana:</label><br>
</div>
<button type="button" id="addChildName" aria-label="Ongera Izina ry'Umwana">Ongera Umwana</button>
<button type="button" id="backToDataFromFamily" aria-label="Subira ku Abakristo Data">Subira Inyuma</button>
<button type="submit" aria-label="Bika Amakuru y'Umuryango">Bika</button>
</form>
</div>
</div>

<!-- Data Page -->
<div id="dataPage" class="hidden">
<h2>Abakristo Saved Data</h2>
<div id="searchContainer"></div> <!-- New: Search input will be added here -->
<label class="filter-label">Sura kuri Presbytery:</label>
<select id="filterPresby" aria-label="Sura kuri Presbytery"><option value="">--Byose--</option></select>
<label class="filter-label">Sura kuri Paruwasi:</label>
<select id="filterParish" aria-label="Sura kuri Paruwasi"><option value="">--Byose--</option></select><br>
<button id="toggleView" aria-label="Reba Abakristo">Reba Abakristo</button>
<button id="downloadCSV" aria-label="Kuramo CSV">Kuramo CSV</button>
<button id="shareData" aria-label="Sambaza Amakuru">Sambaza</button>
<button id="openArchiveBtn" aria-label="Reba Archive">Reba Archive</button>
<!-- Chart Container -->
<div id="chartContainer">
<canvas id="memberChart"></canvas>
</div>
<!-- Members Table -->
<div id="memberListContainer" class="hidden">
<table id="memberTable">
<thead>
<tr>
<th>Presbytery</th><th>Paruwasi</th><th>Ishuri</th>
<th>Itorero ry'ibanze</th><th>No</th>
<th>Irangamuntu</th><th>Amazina</th><th>Igitsina</th><th>Ububatizo</th><th>Umwaka w'Amavuko</th><th>Telefone</th>
<th>Urwego rw'amashuri</th><th>Icyo akora</th><th>Amazina y'Abana</th><th>Ibikorwa</th>
</tr>
</thead>
<tbody id="memberTableBody"></tbody>
</table>
<div id="pagination"></div>
</div>
<div id="activityLogContainer"></div> <!-- New: Activity log -->
<button id="backToMainFromData" aria-label="Subira ku rubuga rw'ibanze">Subira Inyuma</button>
</div>

<!-- Archive Page -->
<div id="archivePage" class="hidden">
<h2>Abakristo mu Bubiko</h2>
<div id="archiveListContainer">
<table id="archiveTable">
<thead>
<tr>
<th>Presbytery</th><th>Paruwasi</th><th>Ishuri</th>
<th>Itorero ry'ibanze</th><th>No</th>
<th>Irangamuntu</th><th>Amazina</th><th>Igitsina</th><th>Ububatizo</th><th>Umwaka w'Amavuko</th><th>Telefone</th>
<th>Urwego rw'amashuri</th><th>Icyo akora</th><th>Amazina y'Abana</th><th>Ibikorwa</th>
</tr>
</thead>
<tbody id="archiveTableBody"></tbody>
</table>
</div>
<button id="backFromArchive" aria-label="Subira Inyuma">Subira Inyuma</button>
</div>

<!-- Transfer Modal -->
<div id="overlay" class="hidden"></div>
<div id="transferModal" class="hidden">
<span class="close-btn" id="closeTransfer" aria-label="Funga Modal">&times;</span>
<h3>Kohereza Umukristo</h3>
<label>Presbytery:</label>
<select id="transferPresby" aria-label="Hitamo Presbytery"></select><br>
<label>Paruwasi:</label>
<select id="transferParish" aria-label="Hitamo Paruwasi"></select><br>
<label>Ishuri:</label>
<select id="transferSchool" aria-label="Hitamo Ishuri"></select><br>
<div id="transferSchoolError" class="error-message hidden"></div>
<label>Itorero ry'ibanze:</label>
<select id="transferSchool2" aria-label="Hitamo Itorero ry'ibanze"></select><br>
<div id="transferSchool2Error" class="error-message hidden"></div>
<label>Urwego rw'amashuri yize:</label>
<select id="transferEducation" aria-label="Hitamo urwego rw'amashuri yize">
  <option value="">---Hitamo---</option>
  <option value="Ntazi gusoma">Ntazi gusoma</option>
  <option value="Isomero">Isomero</option>
  <option value="Abanza">Abanza</option>
  <option value="Ayisumbuye">Ayisumbuye</option>
  <option value="Kaminuza">Kaminuza</option>
  <option value="Masters">Masters</option>
  <option value="PHD">PHD</option>
  <option value="Professor">Professor</option>
</select><br>
<div id="transferEducationError" class="error-message hidden"></div>
<label>Icyo akora:</label>
<select id="transferJob" aria-label="Hitamo icyo akora">
  <option value="">---Hitamo---</option>
  <option value="Ntakazi agira">Ntakazi agira</option>
  <option value="Arikorera">Arikorera</option>
  <option value="Akorera abandi">Akorera abandi</option>
  <option value="Akorera leta">Akorera leta</option>
  <option value="Akorera NGOs">Akorera NGOs</option>
</select><br>
<div id="transferJobError" class="error-message hidden"></div>
<label>Uwo bashyingiranwe:</label>
<input type="text" id="transferSpouse" aria-label="Izina ry'uwo bashyingiranwe"><br>
<label>Umwaka bashyingiranwe:</label>
<select id="transferMarriageYear" aria-label="Hitamo umwaka bashyingiranwe"><option value="">--Hitamo Umwaka--</option></select><br>
<div id="transferMarriageYearError" class="error-message hidden"></div>
<label>Umubare w'abana:</label>
<input type="number" id="transferChildren" min="0" aria-label="Umubare w'abana"><br>
<div id="transferChildrenError" class="error-message hidden"></div>
<div id="transferChildrenNamesContainer">
  <label>Amazina y'Abana:</label><br>
</div>
<button type="button" id="addTransferChildName" aria-label="Ongera Izina ry'Umwana">Ongera Umwana</button>
<button id="transferSave" aria-label="Bika Amakuru">Bika</button>
<button id="transferCancel" aria-label="Hagarika">Hagarika</button>
</div>

<script>
// Data
let members = [];
let archive = [];
let activityLog = [];
let saveCount = 0;
try {
  members = JSON.parse(localStorage.getItem('members')) || [];
  archive = JSON.parse(localStorage.getItem('archive')) || [];
  activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
  members = members.map(m => ({ 
    ...m, 
    education: m.education || '', 
    job: m.job || '', 
    maritalStatus: m.maritalStatus || '', 
    spouse: m.spouse || '', 
    marriageYear: m.marriageYear || '', 
    children: m.children || '0',
    childNames: m.childNames || []
  }));
  archive = archive.map(m => ({ 
    ...m, 
    education: m.education || '', 
    job: m.job || '', 
    maritalStatus: m.maritalStatus || '',
    spouse: m.spouse || '', 
    marriageYear: m.marriageYear || '', 
    children: m.children || '0',
    childNames: m.childNames || []
  }));
  saveToLocalStorage('members', members);
  saveToLocalStorage('archive', archive);
  saveToLocalStorage('activityLog', activityLog);
} catch (e) {
  console.error('Error accessing localStorage:', e);
  alert('Habaye ikibazo mu kubika amakuru. Kuramo amakuru muri CSV kugira ngo urinde kuyapoteza.');
}

let currentPresbytery = '', currentParish = '';
let editingIndex = -1;
let transferIndex = -1;
let familyEditIndex = -1;
let chartInstance = null;

const presbyteries = {
  "GISENYI": ["Gacuba", "Kayove", "Rugarama", "Karisimbi", "Kigarama", "Bushaka", "Rubavu", "Kinanira", "Nyabirasi", "Mukingo", "Kijote", "Nkuri", "Gahondogo", "Ruhengeri", "Kidaho", "Nyarutovu", "Ramba", "Mutake", "Karambo", "Giciye", "Nganzo", "Buganamana"],
  "KIGALI": ["Kamuhoza", "Kacyiru", "Kigali-Central"],
  "RUBENGERA": ["Sure", "Rubengera", "Gashashi"],
  "KIRINDA": ["Kuruganda", "Kirinda-Central", "Ngoma"],
  "GITARAMA": ["Mututu", "Kabgayi", "Nyamagana"],
  "REMERA": ["Bubazi", "Remera-Central", "Ndera"],
  "ZINGA": ["Kibungo", "Rukira", "Gahini"]
};

const schools = ["Gacuba", "Kabirizi", "Rugerero", "Basa"];
const localChurches = {
  "Gacuba": ["Gikarani", "Nengo", "Nyakabungo", "Makoro", "Mbugangali", "Buhuru", "Kanembwe"],
  "Kabirizi": ["Kiroji", "Rohero"],
  "Rugerero": ["Pfunda", "Rugerero", "Ruhangiro", "Gisa"],
  "Basa": ["Nyaruhengeri", "Gahinga", "Mwumba"]
};

// DOM Elements
const startBtn = document.getElementById('startBtn');
const viewDataBtn = document.getElementById('viewDataBtn');
const presbyteriesPage = document.getElementById('presbyteriesPage');
const memberFormPage = document.getElementById('memberFormPage');
const dataPage = document.getElementById('dataPage');
const familyInfoPage = document.getElementById('familyInfoPage');
const presbyList = document.getElementById('presbyList');
const backToMain = document.getElementById('backToMain');
const backToPresby = document.getElementById('backToPresby');
const backToMainFromData = document.getElementById('backToMainFromData');
const backToDataFromFamily = document.getElementById('backToDataFromFamily');
const schoolSelect = document.getElementById('schoolSelect');
const schoolSelect2 = document.getElementById('schoolSelect2');
const yearSelect = document.getElementById('yearSelect');
const educationSelect = document.getElementById('educationSelect');
const jobStatusSelect = document.getElementById('jobStatusSelect');
const familyForm = document.getElementById('familyForm');
const familyName = document.getElementById('familyName');
const familyMaritalStatus = document.getElementById('familyMaritalStatus');
const spouseInput = document.getElementById('spouseInput');
const marriageYearSelect = document.getElementById('marriageYearSelect');
const childrenInput = document.getElementById('childrenInput');
const childrenNamesContainer = document.getElementById('childrenNamesContainer');
const addChildNameBtn = document.getElementById('addChildName');
const filterPresby = document.getElementById('filterPresby');
const filterParish = document.getElementById('filterParish');
const tableBody = document.getElementById('memberTableBody');
const tableContainer = document.getElementById('memberListContainer');
const archivePage = document.getElementById('archivePage');
const archiveTableBody = document.getElementById('archiveTableBody');
const backFromArchive = document.getElementById('backFromArchive');
const openArchiveBtn = document.getElementById('openArchiveBtn');
const overlay = document.getElementById('overlay');
const transferModal = document.getElementById('transferModal');
const transferPresby = document.getElementById('transferPresby');
const transferParish = document.getElementById('transferParish');
const transferSchool = document.getElementById('transferSchool');
const transferSchool2 = document.getElementById('transferSchool2');
const transferEducation = document.getElementById('transferEducation');
const transferJob = document.getElementById('transferJob');
const transferSpouse = document.getElementById('transferSpouse');
const transferMarriageYear = document.getElementById('transferMarriageYear');
const transferChildren = document.getElementById('transferChildren');
const transferChildrenNamesContainer = document.getElementById('transferChildrenNamesContainer');
const addTransferChildNameBtn = document.getElementById('addTransferChildName');
const transferSave = document.getElementById('transferSave');
const transferCancel = document.getElementById('transferCancel');
const closeTransfer = document.getElementById('closeTransfer');
const autoNoField = document.getElementById('autoNo');
const memberForm = document.getElementById('memberForm');
const searchContainer = document.getElementById('searchContainer');
const activityLogContainer = document.getElementById('activityLogContainer');

// Simulated Server Sync (Replace with real API endpoint, e.g., xAI API at https://x.ai/api)
async function saveToServer(data, endpoint) {
  try {
    // Example: Replace with actual fetch to your server or xAI API
    const response = await fetch(`https://api.example.com/${endpoint}`, {  // Change to real URL
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Network error');
    return await response.json();
  } catch (e) {
    console.error(`Error syncing with server: ${e}`);
    alert('Habaye ikibazo mu kohereza amakuru kuri server. Bika muri localStorage.');
    return null;
  }
}

// Utility function for localStorage with server sync
async function saveToLocalStorage(key, data) {
  try {
    localStorage.setItem(key, JSON.stringify(data));
    const serverResponse = await saveToServer(data, key);
    if (serverResponse) {
      console.log(`Successfully synced ${key} to server`);
    }
  } catch (e) {
    console.error(`Error saving ${key} to localStorage:`, e);
    alert('Habaye ikibazo mu kubika amakuru. Kuramo amakuru muri CSV kugira ngo urinde kuyapoteza.');
  }
}

// Auto backup to CSV every 10 saves
function autoBackupToCSV() {
  if (++saveCount % 10 === 0) {
    document.getElementById('downloadCSV').click();
    alert('Backup ya CSV yabitswe byikoresha!');
  }
}

// Show error message with accessibility
function showError(elementId, message) {
  const errorElement = document.getElementById(`${elementId}Error`);
  if (errorElement) {
    errorElement.textContent = message;
    errorElement.classList.remove('hidden');
    errorElement.setAttribute('aria-live', 'polite');
    const input = document.getElementById(elementId);
    input.classList.add('error');
    input.setAttribute('aria-describedby', `${elementId}Error`);
  }
}

// Clear error message
function clearError(elementId) {
  const errorElement = document.getElementById(`${elementId}Error`);
  if (errorElement) {
    errorElement.textContent = '';
    errorElement.classList.add('hidden');
    const input = document.getElementById(elementId);
    input.classList.remove('error');
    input.removeAttribute('aria-describedby');
  }
}

// Populate dropdowns
schools.forEach(s => {
  let o = document.createElement('option');
  o.textContent = s;
  o.value = s;
  schoolSelect.appendChild(o);
  let t = document.createElement('option');
  t.textContent = s;
  t.value = s;
  transferSchool.appendChild(t);
});

function updateLocalChurchesDropdown() {
  schoolSelect2.innerHTML = '<option value="">--Hitamo Itorero--</option>';
  const selectedSchool = schoolSelect.value;
  if (selectedSchool && localChurches[selectedSchool]) {
    localChurches[selectedSchool].forEach(c => {
      let o = document.createElement('option');
      o.textContent = c;
      o.value = c;
      schoolSelect2.appendChild(o);
    });
  }
}
schoolSelect.onchange = () => {
  updateLocalChurchesDropdown();
  clearError('schoolSelect');
};

for (let y = 1900; y <= 2025; y++) {
  let o = document.createElement('option');
  o.textContent = y;
  o.value = y;
  yearSelect.appendChild(o);
  let m = document.createElement('option');
  m.textContent = y;
  m.value = y;
  marriageYearSelect.appendChild(m);
  let t = document.createElement('option');
  t.textContent = y;
  t.value = y;
  transferMarriageYear.appendChild(t);
}

Object.keys(presbyteries).forEach(p => {
  let o = document.createElement('option');
  o.textContent = p;
  o.value = p;
  filterPresby.appendChild(o);
});

// Generate unique member number
function getNextMemberNo() {
  const allNos = [...members, ...archive].map(m => parseInt(m.no)).filter(n => !isNaN(n));
  return allNos.length ? Math.max(...allNos) + 1 : 1;
}

// Dynamic Child Name Inputs for Family Form with unique IDs
function updateChildNameInputs(numChildren, existingNames = []) {
  childrenNamesContainer.innerHTML = '<label>Amazina y\'Abana:</label><br>';
  for (let i = 0; i < numChildren; i++) {
    const input = document.createElement('input');
    input.type = 'text';
    input.id = `child-name-${i}`; // Unique ID
    input.placeholder = `Izina ry'Umwana ${i + 1}`;
    input.value = existingNames[i] || '';
    input.className = 'child-name-input';
    input.setAttribute('aria-label', `Izina ry'Umwana ${i + 1}`);
    childrenNamesContainer.appendChild(input);
    childrenNamesContainer.appendChild(document.createElement('br'));
  }
}

childrenInput.addEventListener('change', function() {
  const numChildren = parseInt(childrenInput.value) || 0;
  updateChildNameInputs(numChildren, members[familyEditIndex]?.childNames || []);
  clearError('childrenInput');
});

addChildNameBtn.onclick = function() {
  const numChildren = parseInt(childrenInput.value) || 0;
  childrenInput.value = numChildren + 1;
  updateChildNameInputs(numChildren + 1, members[familyEditIndex]?.childNames || []);
};

// Dynamic Child Name Inputs for Transfer Modal
function updateTransferChildNameInputs(numChildren, existingNames = []) {
  transferChildrenNamesContainer.innerHTML = '<label>Amazina y\'Abana:</label><br>';
  for (let i = 0; i < numChildren; i++) {
    const input = document.createElement('input');
    input.type = 'text';
    input.id = `transfer-child-name-${i}`; // Unique ID
    input.placeholder = `Izina ry'Umwana ${i + 1}`;
    input.value = existingNames[i] || '';
    input.className = 'transfer-child-name-input';
    input.setAttribute('aria-label', `Izina ry'Umwana ${i + 1}`);
    transferChildrenNamesContainer.appendChild(input);
    transferChildrenNamesContainer.appendChild(document.createElement('br'));
  }
}

transferChildren.addEventListener('change', function() {
  const numChildren = parseInt(transferChildren.value) || 0;
  updateTransferChildNameInputs(numChildren, members[transferIndex]?.childNames || []);
  clearError('transferChildren');
});

addTransferChildNameBtn.onclick = function() {
  const numChildren = parseInt(transferChildren.value) || 0;
  transferChildren.value = numChildren + 1;
  updateTransferChildNameInputs(numChildren + 1, members[transferIndex]?.childNames || []);
};

// Navigation
startBtn.onclick = () => {
  startBtn.classList.add('hidden');
  viewDataBtn.classList.add('hidden');
  presbyteriesPage.classList.remove('hidden');
  renderPresbyteries();
};

backToMain.onclick = () => {
  presbyteriesPage.classList.add('hidden');
  startBtn.classList.remove('hidden');
  viewDataBtn.classList.remove('hidden');
};

viewDataBtn.onclick = () => {
  startBtn.classList.add('hidden');
  viewDataBtn.classList.add('hidden');
  dataPage.classList.remove('hidden');
  updateFilterParish();
  renderTable();
  renderChart();
  addSearchFunctionality();
  renderActivityLog();
};

backToMainFromData.onclick = () => {
  dataPage.classList.add('hidden');
  tableContainer.classList.add('hidden');
  startBtn.classList.remove('hidden');
  viewDataBtn.classList.remove('hidden');
};

backToPresby.onclick = () => {
  memberFormPage.classList.add('hidden');
  presbyteriesPage.classList.remove('hidden');
};

backToDataFromFamily.onclick = () => {
  familyInfoPage.classList.add('hidden');
  dataPage.classList.remove('hidden');
  tableContainer.classList.remove('hidden');
  renderTable();
};

// Render presbyteries
function renderPresbyteries() {
  presbyList.innerHTML = '';
  for (const presby in presbyteries) {
    const p = document.createElement('p');
    p.innerHTML = `<strong>${presby}</strong>`;
    presbyList.appendChild(p);
    const label = document.createElement('label');
    label.textContent = 'Hitamo Paruwasi:';
    presbyList.appendChild(label);
    const select = document.createElement('select');
    select.setAttribute('aria-label', `Hitamo Paruwasi ya ${presby}`);
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = '--Hitamo--';
    select.appendChild(defaultOpt);
    presbyteries[presby].forEach(parish => {
      let o = document.createElement('option');
      o.value = parish;
      o.textContent = parish;
      select.appendChild(o);
    });
    select.onchange = function() {
      if (this.value) {
        currentPresbytery = presby;
        currentParish = this.value;
        memberFormPage.classList.remove('hidden');
        presbyteriesPage.classList.add('hidden');
        if (editingIndex < 0) autoNoField.value = getNextMemberNo();
        updateLocalChurchesDropdown();
      }
    };
    presbyList.appendChild(select);
  }
}

// Real-time input validation
document.getElementById('idInput').addEventListener('input', function() {
  const idInput = this.value;
  if (!/^[1-9][0-9]{15}$/.test(idInput)) {
    showError('idInput', 'Irangamuntu igomba kuba imibare 16 itangira n’umubare utari 0');
  } else {
    clearError('idInput');
  }
});

document.getElementById('phoneInput').addEventListener('input', function() {
  const phoneInput = this.value;
  if (!/^07[0-9]{8}$/.test(phoneInput)) {
    showError('phoneInput', 'Numero ya telefone igomba kuba imibare 10 itangira na 07');
  } else if (members.some(m => m.phone === phoneInput && members.indexOf(m) !== editingIndex)) {
    showError('phoneInput', 'Iyi numero ya telefone isanzwe mu bice byabitswe!');
  } else {
    clearError('phoneInput');
  }
});

document.getElementById('nameInput').addEventListener('input', function() {
  const nameInput = this.value;
  if (nameInput.trim() === '') {
    showError('nameInput', 'Izina rigomba kuba ryanditswe!');
  } else {
    clearError('nameInput');
  }
});

// Member Form Submit with full validation
memberForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  const idInput = document.getElementById('idInput').value;
  const phoneInput = document.getElementById('phoneInput').value;
  const nameInput = document.getElementById('nameInput').value;
  const gender = document.getElementById('genderSelect').value;
  const selectedSchool = document.getElementById('schoolSelect').value;
  const selectedLocalChurch = document.getElementById('schoolSelect2').value;
  const selectedEducation = document.getElementById('educationSelect').value;
  const selectedJob = document.getElementById('jobStatusSelect').value;

  let hasError = false;
  if (!/^[1-9][0-9]{15}$/.test(idInput)) {
    showError('idInput', 'Irangamuntu igomba kuba imibare 16 itangira n’umubare utari 0');
    hasError = true;
  }
  if (members.some(m => m.id === idInput && members.indexOf(m) !== editingIndex)) {
    showError('idInput', 'Irangamuntu iri mu bice byabitswe! Hitamo irindi.');
    hasError = true;
  }
  if (!/^07[0-9]{8}$/.test(phoneInput)) {
    showError('phoneInput', 'Numero ya telefone igomba kuba imibare 10 itangira na 07');
    hasError = true;
  }
  if (members.some(m => m.phone === phoneInput && members.indexOf(m) !== editingIndex)) {
    showError('phoneInput', 'Iyi numero ya telefone isanzwe mu bice byabitswe!');
    hasError = true;
  }
  if (!nameInput.trim()) {
    showError('nameInput', 'Izina rigomba kuba ryanditswe!');
    hasError = true;
  }
  if (!gender) {
    showError('genderSelect', 'Ugomba guhitamo Igitsina!');
    hasError = true;
  }
  if (!selectedSchool) {
    showError('schoolSelect', 'Ugomba guhitamo Ishuri!');
    hasError = true;
  }
  if (!selectedLocalChurch) {
    showError('schoolSelect2', 'Ugomba guhitamo Itorero ry\'ibanze!');
    hasError = true;
  }
  if (!selectedEducation) {
    showError('educationSelect', 'Ugomba guhitamo Urwego rw\'amashuri!');
    hasError = true;
  }
  if (!selectedJob) {
    showError('jobStatusSelect', 'Ugomba guhitamo Icyo akora!');
    hasError = true;
  }
  if (hasError) return;

  const memberData = {
    presbytery: currentPresbytery,
    parish: currentParish,
    no: autoNoField.value,
    school: selectedSchool,
    school2: selectedLocalChurch,
    id: idInput,
    name: nameInput,
    gender: gender,
    maritalStatus: document.getElementById('MartalstatusSelect').value,
    baptism: document.getElementById('baptismSelect').value,
    birthYear: document.getElementById('yearSelect').value,
    phone: phoneInput,
    education: selectedEducation,
    job: selectedJob,
    spouse: '',
    marriageYear: '',
    children: '0',
    childNames: []
  };
  if (editingIndex >= 0) {
    memberData.spouse = members[editingIndex].spouse || '';
    memberData.marriageYear = members[editingIndex].marriageYear || '';
    memberData.children = members[editingIndex].children || '0';
    memberData.childNames = members[editingIndex].childNames || [];
    members[editingIndex] = memberData;
    editingIndex = -1;
    alert('Amakuru yahinduwe!');
    logActivity('edit', `Edited member ${memberData.name} (ID: ${memberData.id})`);
  } else {
    members.push(memberData);
    alert('Amakuru yabitswe!');
    logActivity('add', `Added member ${memberData.name} (ID: ${memberData.id})`);
  }
  await saveToLocalStorage('members', members);
  autoBackupToCSV();
  memberForm.reset();
  autoNoField.value = getNextMemberNo();
  updateFilterParish();
  renderTable();
  renderChart();
  renderActivityLog();
});

// Family Form Submit with child names validation
familyForm.addEventListener('submit', async function(e) {
  e.preventDefault();
  if (familyEditIndex >= 0) {
    const maritalStatus = members[familyEditIndex].maritalStatus;
    const spouse = spouseInput.value;
    const marriageYear = marriageYearSelect.value;
    const children = childrenInput.value || '0';
    const childNames = Array.from(document.querySelectorAll('.child-name-input')).map(input => input.value.trim());
    if ((maritalStatus === 'arubatse' || maritalStatus === 'divorce') && marriageYear === '') {
      showError('marriageYearSelect', 'Igihe bashyingiranwe kirakenewe iyo irangamimerere ni Arubatse cyangwa Divorce!');
      return;
    }
    if (parseInt(children) > 0 && childNames.some(name => name === '')) {
      showError('childrenInput', 'Amazina y’abana yose agomba kuba yanditswe iyo umubare w’abana uri > 0!');
      return;
    }
    if (parseInt(children) !== childNames.filter(name => name !== '').length) {
      showError('childrenInput', 'Umubare w\'abana ugomba kuba ungana n\'amazina y\'abana wanditswe!');
      return;
    }
    members[familyEditIndex].spouse = spouse;
    members[familyEditIndex].marriageYear = marriageYear;
    members[familyEditIndex].children = children;
    members[familyEditIndex].childNames = childNames.filter(name => name !== '');
    await saveToLocalStorage('members', members);
    logActivity('family_update', `Updated family for ${members[familyEditIndex].name}`);
    alert('Amakuru y\'umuryango yabitswe!');
    familyForm.reset();
    updateChildNameInputs(0);
    familyInfoPage.classList.add('hidden');
    dataPage.classList.remove('hidden');
    tableContainer.classList.remove('hidden');
    renderTable();
    renderActivityLog();
  }
});

// Render Members Table with Pagination (supports filtered data)
function renderTable(page = 1, pageSize = 10, dataSource = members) {
  const presbyFilter = filterPresby.value;
  const parishFilter = filterParish.value;
  tableBody.innerHTML = '';
  const filtered = dataSource.filter(m =>
    (presbyFilter === '' || m.presbytery === presbyFilter) &&
    (parishFilter === '' || m.parish === parishFilter)
  );
  const start = (page - 1) * pageSize;
  const end = start + pageSize;
  const paginated = filtered.slice(start, end);
  if (paginated.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 15;
    td.textContent = 'Nta makuru yabitswe';
    tr.appendChild(td);
    tableBody.appendChild(tr);
  } else {
    paginated.forEach((m, index) => {
      const tr = document.createElement('tr');
      ['presbytery', 'parish', 'school', 'school2', 'no', 'id', 'name', 'gender', 'baptism', 'birthYear', 'phone', 'education', 'job', 'childNames'].forEach(key => {
        const td = document.createElement('td');
        td.textContent = key === 'childNames' ? (m[key] || []).join(', ') : m[key] || '';
        tr.appendChild(td);
      });
      const tdActions = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Hindura';
      editBtn.className = 'action-btn';
      editBtn.setAttribute('aria-label', `Hindura amakuru ya ${m.name}`);
      editBtn.onclick = function() {
        autoNoField.value = m.no;
        document.getElementById('schoolSelect').value = m.school;
        updateLocalChurchesDropdown();
        document.getElementById('schoolSelect2').value = m.school2;
        document.getElementById('idInput').value = m.id;
        document.getElementById('nameInput').value = m.name;
        document.getElementById('genderSelect').value = m.gender;
        document.getElementById('MartalstatusSelect').value = m.maritalStatus;
        document.getElementById('baptismSelect').value = m.baptism;
        document.getElementById('yearSelect').value = m.birthYear;
        document.getElementById('phoneInput').value = m.phone;
        document.getElementById('educationSelect').value = m.education || '';
        document.getElementById('jobStatusSelect').value = m.job || '';
        currentPresbytery = m.presbytery;
        currentParish = m.parish;
        editingIndex = members.indexOf(m);
        memberFormPage.classList.remove('hidden');
        dataPage.classList.add('hidden');
      };
      tdActions.appendChild(editBtn);
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Siba';
      delBtn.className = 'action-btn';
      delBtn.setAttribute('aria-label', `Siba amakuru ya ${m.name}`);
      delBtn.onclick = async function() {
        if (confirm(`Urashaka gusiba ${m.name}?`)) {
          members.splice(members.indexOf(m), 1);
          await saveToLocalStorage('members', members);
          logActivity('delete', `Deleted member ${m.name}`);
          renderTable(page);
          renderChart();
          renderActivityLog();
        }
      };
      tdActions.appendChild(delBtn);
      const archBtn = document.createElement('button');
      archBtn.textContent = 'Bika mu Bubiko';
      archBtn.className = 'action-btn';
      archBtn.setAttribute('aria-label', `Bika ${m.name} mu bubiko`);
      archBtn.onclick = async function() {
        archive.push(m);
        members.splice(members.indexOf(m), 1);
        await saveToLocalStorage('members', members);
        await saveToLocalStorage('archive', archive);
        logActivity('archive', `Archived member ${m.name}`);
        renderTable(page);
        renderChart();
        renderActivityLog();
      };
      tdActions.appendChild(archBtn);
      const transBtn = document.createElement('button');
      transBtn.textContent = 'Ohereza';
      transBtn.className = 'action-btn';
      transBtn.setAttribute('aria-label', `Ohereza ${m.name} ku yandi paruwasi`);
      transBtn.onclick = function() {
        transferIndex = members.indexOf(m);
        openTransferModal(m);
      };
      tdActions.appendChild(transBtn);
      const familyBtn = document.createElement('button');
      familyBtn.textContent = 'Umuryango';
      familyBtn.className = 'action-btn';
      familyBtn.setAttribute('aria-label', `Reba amakuru y'umuryango ya ${m.name}`);
      familyBtn.onclick = function() {
        familyEditIndex = members.indexOf(m);
        familyName.value = m.name;
        familyMaritalStatus.value = m.maritalStatus || '';
        spouseInput.value = m.spouse || '';
        marriageYearSelect.value = m.marriageYear || '';
        childrenInput.value = m.children || '0';
        updateChildNameInputs(parseInt(m.children) || 0, m.childNames || []);
        dataPage.classList.add('hidden');
        familyInfoPage.classList.remove('hidden');
      };
      tdActions.appendChild(familyBtn);
      tr.appendChild(tdActions);
      tableBody.appendChild(tr);
    });
  }
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = `
    <button onclick="renderTable(${page - 1}, 10, filtered)" ${page === 1 ? 'disabled' : ''} aria-label="Subira ku ipage ry'inyuma">Ibanze</button>
    <span>Page ${page}</span>
    <input type="number" min="1" max="${Math.ceil(filtered.length / pageSize)}" value="${page}" onchange="renderTable(this.value, 10, filtered)" aria-label="Hitamo ipage">
    <button onclick="renderTable(${page + 1}, 10, filtered)" ${end >= filtered.length ? 'disabled' : ''} aria-label="Genda ku ipage rikurikira">Ibikurikira</button>
  `;
}

// Filter Parish
function updateFilterParish() {
  filterParish.innerHTML = '';
  let defaultOpt = document.createElement('option');
  defaultOpt.value = '';
  defaultOpt.textContent = '--Byose--';
  filterParish.appendChild(defaultOpt);
  const presby = filterPresby.value;
  let parishesList = [];
  if (presby === '') {
    for (let p in presbyteries) {
      parishesList = parishesList.concat(presbyteries[p]);
    }
  } else {
    parishesList = presbyteries[presby];
  }
  parishesList.forEach(par => {
    let o = document.createElement('option');
    o.value = par;
    o.textContent = par;
    filterParish.appendChild(o);
  });
}

filterPresby.onchange = () => {
  updateFilterParish();
  renderTable();
  renderChart();
};

filterParish.onchange = () => {
  renderTable();
  renderChart();
};

// Toggle Table
document.getElementById('toggleView').onclick = function() {
  if (tableContainer.classList.contains('hidden')) {
    tableContainer.classList.remove('hidden');
    renderTable();
  } else {
    tableContainer.classList.add('hidden');
  }
};

// CSV Download
document.getElementById('downloadCSV').onclick = function() {
  if (members.length === 0) {
    alert('Nta makuru yabitswe');
    return;
  }
  const csvHeader = [...Object.keys(members[0]).filter(k => k !== 'childNames'), 'childNames'].join(',') + '\n';
  const csvRows = members.map(m => {
    const values = Object.values(m).map((v, i) => {
      if (Object.keys(m)[i] === 'childNames') {
        return `"${(v || []).join(';')}"`;
      }
      return `"${v || ''}"`;
    });
    return values.join(',');
  }).join('\n');
  const bom = '\uFEFF';
  const blob = new Blob([bom + csvHeader + csvRows], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'abakristo.csv';
  a.click();
  URL.revokeObjectURL(url);
};

// Share
document.getElementById('shareData').onclick = function() {
  if (members.length === 0) {
    alert('Nta makuru yabitswe');
    return;
  }
  const textData = members.map(m => 
    `${m.no} - ${m.name} - ${m.school} - ${m.school2} - ${m.education} - ${m.job} - ${m.spouse || ''} - ${m.marriageYear || ''} - ${m.children || '0'} - ${(m.childNames || []).join(', ')}`
  ).join('\n');
  if (navigator.share) {
    navigator.share({ title: 'Abakristo Data', text: textData }).catch(console.error);
  } else {
    alert('Sambaza ntishyigikirwa');
  }
};

// Archive Page
openArchiveBtn.onclick = function() {
  dataPage.classList.add('hidden');
  archivePage.classList.remove('hidden');
  renderArchive();
};

backFromArchive.onclick = function() {
  archivePage.classList.add('hidden');
  dataPage.classList.remove('hidden');
};

function renderArchive() {
  archiveTableBody.innerHTML = '';
  if (archive.length === 0) {
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = 15;
    td.textContent = 'Nta makuru mu bubiko';
    tr.appendChild(td);
    archiveTableBody.appendChild(tr);
    return;
  }
  archive.forEach(m => {
    const tr = document.createElement('tr');
    ['presbytery', 'parish', 'school', 'school2', 'no', 'id', 'name', 'gender', 'baptism', 'birthYear', 'phone', 'education', 'job', 'childNames'].forEach(k => {
      let td = document.createElement('td');
      td.textContent = k === 'childNames' ? (m[k] || []).join(', ') : m[k] || '';
      tr.appendChild(td);
    });
    const tdActions = document.createElement('td');
    const resBtn = document.createElement('button');
    resBtn.textContent = 'Garura';
    resBtn.setAttribute('aria-label', `Garura ${m.name} mu bubiko`);
    resBtn.onclick = async function() {
      members.push(m);
      archive.splice(archive.indexOf(m), 1);
      await saveToLocalStorage('members', members);
      await saveToLocalStorage('archive', archive);
      logActivity('restore', `Restored member ${m.name} from archive`);
      renderArchive();
      renderChart();
      renderActivityLog();
    };
    tdActions.appendChild(resBtn);
    tr.appendChild(tdActions);
    archiveTableBody.appendChild(tr);
  });
}

// Transfer
function openTransferModal(m) {
  overlay.classList.remove('hidden');
  transferModal.classList.remove('hidden');
  transferPresby.innerHTML = '';
  Object.keys(presbyteries).forEach(p => {
    let o = document.createElement('option');
    o.value = p;
    o.textContent = p;
    transferPresby.appendChild(o);
  });
  transferPresby.value = m.presbytery;
  transferPresby.onchange = function() {
    transferParish.innerHTML = '';
    presbyteries[transferPresby.value].forEach(par => {
      let o = document.createElement('option');
      o.value = par;
      o.textContent = par;
      transferParish.appendChild(o);
    });
    clearError('transferPresby');
  };
  transferPresby.onchange();
  transferParish.value = m.parish;
  transferSchool.innerHTML = '';
  schools.forEach(s => {
    let o = document.createElement('option');
    o.value = s;
    o.textContent = s;
    transferSchool.appendChild(o);
  });
  transferSchool.value = m.school;
  transferSchool2.innerHTML = '<option value="">--Hitamo Itorero--</option>';
  if (m.school && localChurches[m.school]) {
    localChurches[m.school].forEach(c => {
      let o = document.createElement('option');
      o.value = c;
      o.textContent = c;
      transferSchool2.appendChild(o);
    });
  }
  transferSchool2.value = m.school2;
  transferEducation.value = m.education || '';
  transferJob.value = m.job || '';
  transferSpouse.value = m.spouse || '';
  transferMarriageYear.value = m.marriageYear || '';
  transferChildren.value = m.children || '0';
  updateTransferChildNameInputs(parseInt(m.children) || 0, m.childNames || []);
  transferSchool.onchange = function() {
    transferSchool2.innerHTML = '<option value="">--Hitamo Itorero--</option>';
    const selectedSchool = transferSchool.value;
    if (selectedSchool && localChurches[selectedSchool]) {
      localChurches[selectedSchool].forEach(c => {
        let o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        transferSchool2.appendChild(o);
      });
    }
    clearError('transferSchool');
  };
}

transferSave.onclick = async function() {
  if (transferIndex >= 0) {
    const selectedSchool = transferSchool.value;
    const selectedLocalChurch = transferSchool2.value;
    const selectedEducation = transferEducation.value;
    const selectedJob = transferJob.value;
    const selectedSpouse = transferSpouse.value;
    const selectedMarriageYear = transferMarriageYear.value;
    const selectedChildren = transferChildren.value || '0';
    const selectedChildNames = Array.from(document.querySelectorAll('.transfer-child-name-input')).map(input => input.value.trim()).filter(name => name !== '');
    let hasError = false;
    if (!selectedSchool) {
      showError('transferSchool', 'Ugomba guhitamo Ishuri!');
      hasError = true;
    }
    if (!selectedLocalChurch) {
      showError('transferSchool2', 'Ugomba guhitamo Itorero ry\'ibanze!');
      hasError = true;
    }
    if (!selectedEducation) {
      showError('transferEducation', 'Ugomba guhitamo Urwego rw\'amashuri!');
      hasError = true;
    }
    if (!selectedJob) {
      showError('transferJob', 'Ugomba guhitamo Icyo akora!');
      hasError = true;
    }
    if (transferPresby.value === members[transferIndex].presbytery && transferParish.value === members[transferIndex].parish) {
      alert('Umukristo ntashobora koherezwa mu isibo na paruwasi bimwe na byo asanzweho!');
      hasError = true;
    }
    if ((members[transferIndex].maritalStatus === 'arubatse' || members[transferIndex].maritalStatus === 'divorce') && selectedMarriageYear === '') {
      showError('transferMarriageYear', 'Igihe bashyingiranwe kirakenewe iyo irangamimerere ni Arubatse cyangwa Divorce!');
      hasError = true;
    }
    if (parseInt(selectedChildren) > 0 && selectedChildNames.some(name => name === '')) {
      showError('transferChildren', 'Amazina y’abana yose agomba kuba yanditswe!');
      hasError = true;
    }
    if (parseInt(selectedChildren) !== selectedChildNames.length) {
      showError('transferChildren', 'Umubare w\'abana ugomba kuba ungana n\'amazina y\'abana wanditswe!');
      hasError = true;
    }
    if (hasError) return;

    members[transferIndex].presbytery = transferPresby.value;
    members[transferIndex].parish = transferParish.value;
    members[transferIndex].school = selectedSchool;
    members[transferIndex].school2 = selectedLocalChurch;
    members[transferIndex].education = selectedEducation;
    members[transferIndex].job = selectedJob;
    members[transferIndex].spouse = selectedSpouse;
    members[transferIndex].marriageYear = selectedMarriageYear;
    members[transferIndex].children = selectedChildren;
    members[transferIndex].childNames = selectedChildNames;
    await saveToLocalStorage('members', members);
    logActivity('transfer', `Transferred member ${members[transferIndex].name} to ${transferPresby.value}/${transferParish.value}`);
    alert('Kohereza byagenze neza!');
    renderChart();
    renderActivityLog();
  }
  transferIndex = -1;
  closeTransferModal();
  renderTable();
};

transferCancel.onclick = closeTransferModal;
closeTransfer.onclick = closeTransferModal;

function closeTransferModal() {
  overlay.classList.add('hidden');
  transferModal.classList.add('hidden');
  clearError('transferSchool');
  clearError('transferSchool2');
  clearError('transferEducation');
  clearError('transferJob');
  clearError('transferMarriageYear');
  clearError('transferChildren');
}

// Optimized Render Bar Chart (update instead of destroy)
function renderChart() {
  const ctx = document.getElementById('memberChart').getContext('2d');
  const presbyFilter = filterPresby.value;
  const parishFilter = filterParish.value;
  const filteredMembers = members.filter(m =>
    (presbyFilter === '' || m.presbytery === presbyFilter) &&
    (parishFilter === '' || m.parish === parishFilter)
  );
  const presbyCounts = (presbyFilter ? [presbyFilter] : Object.keys(presbyteries)).map(presby => ({
    presby,
    count: filteredMembers.filter(m => m.presbytery === presby).length
  }));
  const labels = presbyCounts.map(p => p.presby);
  const data = presbyCounts.map(p => p.count);

  if (!data.some(d => d > 0)) {
    document.getElementById('chartContainer').innerHTML = '<canvas id="memberChart"></canvas><p style="text-align: center;">Nta makuru yabonetse kuri ikarita</p>';
    return;
  }

  if (chartInstance) {
    chartInstance.data.labels = labels;
    chartInstance.data.datasets[0].data = data;
    chartInstance.update();
  } else {
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Umubare w’Abakristo muri Presbytery',
          data: data,
          backgroundColor: '#12984c',
          borderColor: '#1ac564',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Umubare w’Abakristo' } },
          x: { title: { display: true, text: 'Presbytery' } }
        },
        plugins: { legend: { display: true } }
      }
    });
  }
}

// Activity Log
function logActivity(action, details) {
  const logEntry = {
    action,
    details,
    timestamp: new Date().toISOString()
  };
  activityLog.push(logEntry);
  saveToLocalStorage('activityLog', activityLog);
}

function renderActivityLog() {
  activityLogContainer.innerHTML = '<h3>Ibikorwa Byakorewe</h3><ul id="activityLogList"></ul>';
  const logList = document.getElementById('activityLogList');
  logList.innerHTML = activityLog.map(log => `
    <li>${log.action}: ${log.details} at ${new Date(log.timestamp).toLocaleString('rw-RW')}</li>
  `).join('');
}

// Search Functionality with Debounce
function addSearchFunctionality() {
  if (searchContainer.innerHTML === '') {
    searchContainer.innerHTML = `
      <label for="searchInput">Sura Umukristo:</label>
      <input type="text" id="searchInput" placeholder="Shyiramo izina, irangamuntu, cyangwa telephone" aria-label="Sura Umukristo">
    `;
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce(function() {
      const query = this.value.toLowerCase();
      const filtered = members.filter(m =>
        m.name.toLowerCase().includes(query) ||
        m.id.includes(query) ||
        m.phone.includes(query)
      );
      renderTable(1, 10, filtered);
    }, 300));
  }
}

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// Keyboard Navigation for Buttons
document.querySelectorAll('button').forEach(btn => {
  btn.setAttribute('tabindex', '0');
  btn.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      btn.click();
    }
  });
});

// Initial
updateFilterParish();
renderTable();
renderChart();
</script>

</body>
</html>
